import {
  CodeSurferLayout,
  Code,
} from "code-surfer";
export { githubFull as theme } from "code-surfer";

# How to develop React useFetch hook

---

<CodeSurferLayout>

```js title="Step1: minimal"
const useFetch = url => {
  const [state, setState] = useState({});
  useEffect(() => {
    const fetchData = async () => {
      const response = await fetch(url);
      const data = await response.json();
      setState({ data });
    };
    fetchData();
  }, [url]);
  return state;
};
```

</CodeSurferLayout>

---

<CodeSurferLayout>

```js subtitle="Create a hook"
const useFetch = url => {

};
```

```js subtitle="Create a state"
const useFetch = url => {
  const [state, setState] = useState({});

  return state;
};
```

```js subtitle="Add an effect"
const useFetch = url => {
  const [state, setState] = useState({});
  useEffect(() => {

  }, [url]);
  return state;
};
```

```js subtitle="Define an async func"
const useFetch = url => {
  const [state, setState] = useState({});
  useEffect(() => {
    const fetchData = async () => {

    };
  }, [url]);
  return state;
};
```

```js subtitle="Invoke the async func"
const useFetch = url => {
  const [state, setState] = useState({});
  useEffect(() => {
    const fetchData = async () => {

    };
    fetchData();
  }, [url]);
  return state;
};
```

```js subtitle="Implement the async func"
const useFetch = url => {
  const [state, setState] = useState({});
  useEffect(() => {
    const fetchData = async () => {
      const response = await fetch(url);
      const data = await response.json();
      setState({ data });
    };
    fetchData();
  }, [url]);
  return state;
};
```

```js 5:6 subtitle="Fetch data"
const useFetch = url => {
  const [state, setState] = useState({});
  useEffect(() => {
    const fetchData = async () => {
      const response = await fetch(url);
      const data = await response.json();
      setState({ data });
    };
    fetchData();
  }, [url]);
  return state;
};
```

```js 7 subtitle="Set state"
const useFetch = url => {
  const [state, setState] = useState({});
  useEffect(() => {
    const fetchData = async () => {
      const response = await fetch(url);
      const data = await response.json();
      setState({ data });
    };
    fetchData();
  }, [url]);
  return state;
};
```

```js 10 subtitle="Follow exhaustive-deps rule"
const useFetch = url => {
  const [state, setState] = useState({});
  useEffect(() => {
    const fetchData = async () => {
      const response = await fetch(url);
      const data = await response.json();
      setState({ data });
    };
    fetchData();
  }, [url]);
  return state;
};
```

</CodeSurferLayout>

---

<CodeSurferLayout>


```js title="Step2: didCleanup flag"
const useFetch = url => {
  const [state, setState] = useState({});
  useEffect(() => {
    let didCleanup = false;
    const fetchData = async () => {
      const response = await fetch(url);
      const data = await response.json();
      if (!didCleanup) {
        setState({ data });
      }
    };
    fetchData();
    const cleanup = () => {
      didCleanup = true;
    };
    return cleanup;
  }, [url]);
  return state;
};
```

</CodeSurferLayout>

---

<CodeSurferLayout>


```js subtitle="From step1"
const useFetch = url => {
  const [state, setState] = useState({});
  useEffect(() => {
    const fetchData = async () => {
      const response = await fetch(url);
      const data = await response.json();
      setState({ data });
    };
    fetchData();
  }, [url]);
  return state;
};
```

```js subtitle="Define a didCleanup flag"
const useFetch = url => {
  const [state, setState] = useState({});
  useEffect(() => {
    let didCleanup = false;
    const fetchData = async () => {
      const response = await fetch(url);
      const data = await response.json();
      setState({ data });
    };
    fetchData();
  }, [url]);
  return state;
};
```

```js subtitle="Define a cleanup func"
const useFetch = url => {
  const [state, setState] = useState({});
  useEffect(() => {
    let didCleanup = false;
    const fetchData = async () => {
      const response = await fetch(url);
      const data = await response.json();
      setState({ data });
    };
    fetchData();
    const cleanup = () => {
      didCleanup = true;
      setState({});
    };
    return cleanup;
  }, [url]);
  return state;
};
```

```js 12 subtitle="Set the didCleanup flag"
const useFetch = url => {
  const [state, setState] = useState({});
  useEffect(() => {
    let didCleanup = false;
    const fetchData = async () => {
      const response = await fetch(url);
      const data = await response.json();
      setState({ data });
    };
    fetchData();
    const cleanup = () => {
      didCleanup = true;
      setState({});
    };
    return cleanup;
  }, [url]);
  return state;
};
```

```js 13 subtitle="Clear state"
const useFetch = url => {
  const [state, setState] = useState({});
  useEffect(() => {
    let didCleanup = false;
    const fetchData = async () => {
      const response = await fetch(url);
      const data = await response.json();
      setState({ data });
    };
    fetchData();
    const cleanup = () => {
      didCleanup = true;
      setState({});
    };
    return cleanup;
  }, [url]);
  return state;
};
```

```js 15 subtitle="Return the cleanup func"
const useFetch = url => {
  const [state, setState] = useState({});
  useEffect(() => {
    let didCleanup = false;
    const fetchData = async () => {
      const response = await fetch(url);
      const data = await response.json();
      setState({ data });
    };
    fetchData();
    const cleanup = () => {
      didCleanup = true;
      setState({});
    };
    return cleanup;
  }, [url]);
  return state;
};
```

```js subtitle="Only set state if not didCleanup"
const useFetch = url => {
  const [state, setState] = useState({});
  useEffect(() => {
    let didCleanup = false;
    const fetchData = async () => {
      const response = await fetch(url);
      const data = await response.json();
      if (!didCleanup) {
        setState({ data });
      }
    };
    fetchData();
    const cleanup = () => {
      didCleanup = true;
      setState({});
    };
    return cleanup;
  }, [url]);
  return state;
};
```

</CodeSurferLayout>

---

<CodeSurferLayout>


```js title="Step3: loading flag"
const useFetch = url => {
  const [state, setState] = useState({});
  useEffect(() => {
    let didCleanup = false;
    const fetchData = async () => {
      const response = await fetch(url);
      const data = await response.json();
      if (!didCleanup) {
        setState({ data });
      }
    };
    setState({ loading: true });
    fetchData();
    const cleanup = () => {
      didCleanup = true;
      setState({});
    };
    return cleanup;
  }, [url]);
  return state;
};
```

</CodeSurferLayout>

---

<CodeSurferLayout>

```js subtitle="From step2"
const useFetch = url => {
  const [state, setState] = useState({});
  useEffect(() => {
    let didCleanup = false;
    const fetchData = async () => {
      const response = await fetch(url);
      const data = await response.json();
      if (!didCleanup) {
        setState({ data });
      }
    };
    fetchData();
    const cleanup = () => {
      didCleanup = true;
      setState({});
    };
    return cleanup;
  }, [url]);
  return state;
};
```

```js subtitle="Set loading flag before fetching"
const useFetch = url => {
  const [state, setState] = useState({});
  useEffect(() => {
    let didCleanup = false;
    const fetchData = async () => {
      const response = await fetch(url);
      const data = await response.json();
      if (!didCleanup) {
        setState({ data });
      }
    };
    setState({ loading: true });
    fetchData();
    const cleanup = () => {
      didCleanup = true;
      setState({});
    };
    return cleanup;
  }, [url]);
  return state;
};
```

</CodeSurferLayout>

---

<CodeSurferLayout>


```js title="Step4: error handling"
const useFetch = url => {
  const [state, setState] = useState({});
  useEffect(() => {
    let didCleanup = false;
    const fetchData = async () => {
      try {
        const response = await fetch(url);
        if (!response.ok) {
          throw new Error('status: ' + response.status);
        }
        const data = await response.json();
        if (!didCleanup) {
          setState({ data });
        }
      } catch (error) {
        if (!didCleanup) {
          setState({ error });
        }
      }
    };
    setState({ loading: true });
    fetchData();
    const cleanup = () => {
      didCleanup = true;
      setState({});
    };
    return cleanup;
  }, [url]);
  return state;
};
```

</CodeSurferLayout>

---

<CodeSurferLayout>

```js subtitle="From step3"
const useFetch = url => {
  const [state, setState] = useState({});
  useEffect(() => {
    let didCleanup = false;
    const fetchData = async () => {
      const response = await fetch(url);
      const data = await response.json();
      if (!didCleanup) {
        setState({ data });
      }
    };
    setState({ loading: true });
    fetchData();
    const cleanup = () => {
      didCleanup = true;
      setState({});
    };
    return cleanup;
  }, [url]);
  return state;
};
```

```js subtitle="Add try-catch"
const useFetch = url => {
  const [state, setState] = useState({});
  useEffect(() => {
    let didCleanup = false;
    const fetchData = async () => {
      try {
        const response = await fetch(url);
        const data = await response.json();
        if (!didCleanup) {
          setState({ data });
        }
      } catch (error) {

      }
    };
    setState({ loading: true });
    fetchData();
    const cleanup = () => {
      didCleanup = true;
      setState({});
    };
    return cleanup;
  }, [url]);
  return state;
};
```

```js subtitle="Set error in catch"
const useFetch = url => {
  const [state, setState] = useState({});
  useEffect(() => {
    let didCleanup = false;
    const fetchData = async () => {
      try {
        const response = await fetch(url);
        const data = await response.json();
        if (!didCleanup) {
          setState({ data });
        }
      } catch (error) {
        if (!didCleanup) {
          setState({ error });
        }
      }
    };
    setState({ loading: true });
    fetchData();
    const cleanup = () => {
      didCleanup = true;
      setState({});
    };
    return cleanup;
  }, [url]);
  return state;
};
```

```js subtitle="Throw error if response is not ok"
const useFetch = url => {
  const [state, setState] = useState({});
  useEffect(() => {
    let didCleanup = false;
    const fetchData = async () => {
      try {
        const response = await fetch(url);
        if (!response.ok) {
          throw new Error('status: ' + response.status);
        }
        const data = await response.json();
        if (!didCleanup) {
          setState({ data });
        }
      } catch (error) {
        if (!didCleanup) {
          setState({ error });
        }
      }
    };
    setState({ loading: true });
    fetchData();
    const cleanup = () => {
      didCleanup = true;
      setState({});
    };
    return cleanup;
  }, [url]);
  return state;
};
```

</CodeSurferLayout>

---

<CodeSurferLayout>


```js title="Step5: cancel handling"
const useFetch = url => {
  const [state, setState] = useState({});
  useEffect(() => {
    let didCleanup = false;
    const abortController = new AbortController();
    const fetchData = async () => {
      try {
        const response = await fetch(url, {
          signal: abortController.signal
        });
        if (!response.ok) {
          throw new Error('status: ' + response.status);
        }
        const data = await response.json();
        if (!didCleanup) {
          setState({ data });
        }
      } catch (error) {
        if (!didCleanup) {
          setState({ error });
        }
      }
    };
    setState({ loading: true });
    fetchData();
    const cleanup = () => {
      didCleanup = true;
      abortController.abort();
      setState({});
    };
    return cleanup;
  }, [url]);
  return state;
};
```

</CodeSurferLayout>

---

<CodeSurferLayout>

```js subtitle="From step4"
const useFetch = url => {
  const [state, setState] = useState({});
  useEffect(() => {
    let didCleanup = false;
    const fetchData = async () => {
      try {
        const response = await fetch(url);
        if (!response.ok) {
          throw new Error('status: ' + response.status);
        }
        const data = await response.json();
        if (!didCleanup) {
          setState({ data });
        }
      } catch (error) {
        if (!didCleanup) {
          setState({ error });
        }
      }
    };
    setState({ loading: true });
    fetchData();
    const cleanup = () => {
      didCleanup = true;
      setState({});
    };
    return cleanup;
  }, [url]);
  return state;
};
```

```js subtitle="Create an AbortController"
const useFetch = url => {
  const [state, setState] = useState({});
  useEffect(() => {
    let didCleanup = false;
    const abortController = new AbortController();
    const fetchData = async () => {
      try {
        const response = await fetch(url);
        if (!response.ok) {
          throw new Error('status: ' + response.status);
        }
        const data = await response.json();
        if (!didCleanup) {
          setState({ data });
        }
      } catch (error) {
        if (!didCleanup) {
          setState({ error });
        }
      }
    };
    setState({ loading: true });
    fetchData();
    const cleanup = () => {
      didCleanup = true;
      setState({});
    };
    return cleanup;
  }, [url]);
  return state;
};
```

```js subtitle="Set signal in fetch"
const useFetch = url => {
  const [state, setState] = useState({});
  useEffect(() => {
    let didCleanup = false;
    const abortController = new AbortController();
    const fetchData = async () => {
      try {
        const response = await fetch(url, {
          signal: abortController.signal
        });
        if (!response.ok) {
          throw new Error('status: ' + response.status);
        }
        const data = await response.json();
        if (!didCleanup) {
          setState({ data });
        }
      } catch (error) {
        if (!didCleanup) {
          setState({ error });
        }
      }
    };
    setState({ loading: true });
    fetchData();
    const cleanup = () => {
      didCleanup = true;
      setState({});
    };
    return cleanup;
  }, [url]);
  return state;
};
```

```js subtitle="Call abort on cleanup"
const useFetch = url => {
  const [state, setState] = useState({});
  useEffect(() => {
    let didCleanup = false;
    const abortController = new AbortController();
    const fetchData = async () => {
      try {
        const response = await fetch(url, {
          signal: abortController.signal
        });
        if (!response.ok) {
          throw new Error('status: ' + response.status);
        }
        const data = await response.json();
        if (!didCleanup) {
          setState({ data });
        }
      } catch (error) {
        if (!didCleanup) {
          setState({ error });
        }
      }
    };
    setState({ loading: true });
    fetchData();
    const cleanup = () => {
      didCleanup = true;
      abortController.abort();
      setState({});
    };
    return cleanup;
  }, [url]);
  return state;
};
```

</CodeSurferLayout>

---

<CodeSurferLayout>

```js title="Step6: fetch options"
const defaultOpts = {};
const defaultReadBody = body => body.json();
const useFetch = (
  url,
  opts = defaultOpts,
  readBody = defaultReadBody,
) => {
  const [state, setState] = useState({});
  useEffect(() => {
    let didCleanup = false;
    const abortController = new AbortController();
    const fetchData = async () => {
      try {
        const response = await fetch(url, {
          ...opts,
          signal: abortController.signal
        });
        if (!response.ok) {
          throw new Error('status: ' + response.status);
        }
        const data = await readBody(response);
        if (!didCleanup) {
          setState({ data });
        }
      } catch (error) {
        if (!didCleanup) {
          setState({ error });
        }
      }
    };
    setState({ loading: true });
    fetchData();
    const cleanup = () => {
      didCleanup = true;
      abortController.abort();
      setState({});
    };
    return cleanup;
  }, [url]);
  return state;
};
```

</CodeSurferLayout>

---

<CodeSurferLayout>

```js subtitle="From step5"
const useFetch = url => {
  const [state, setState] = useState({});
  useEffect(() => {
    let didCleanup = false;
    const abortController = new AbortController();
    const fetchData = async () => {
      try {
        const response = await fetch(url, {
          signal: abortController.signal
        });
        if (!response.ok) {
          throw new Error('status: ' + response.status);
        }
        const data = await response.json();
        if (!didCleanup) {
          setState({ data });
        }
      } catch (error) {
        if (!didCleanup) {
          setState({ error });
        }
      }
    };
    setState({ loading: true });
    fetchData();
    const cleanup = () => {
      didCleanup = true;
      abortController.abort();
      setState({});
    };
    return cleanup;
  }, [url]);
  return state;
};
```

```js subtitle="Define defaults outside of the hook"
const defaultOpts = {};
const defaultReadBody = body => body.json();
const useFetch = url => {
  const [state, setState] = useState({});
  useEffect(() => {
    let didCleanup = false;
    const abortController = new AbortController();
    const fetchData = async () => {
      try {
        const response = await fetch(url, {
          signal: abortController.signal
        });
        if (!response.ok) {
          throw new Error('status: ' + response.status);
        }
        const data = await response.json();
        if (!didCleanup) {
          setState({ data });
        }
      } catch (error) {
        if (!didCleanup) {
          setState({ error });
        }
      }
    };
    setState({ loading: true });
    fetchData();
    const cleanup = () => {
      didCleanup = true;
      abortController.abort();
      setState({});
    };
    return cleanup;
  }, [url]);
  return state;
};
```

```js subtitle="Make the hook received three args with defaults"
const defaultOpts = {};
const defaultReadBody = body => body.json();
const useFetch = (
  url,
  opts = defaultOpts,
  readBody = defaultReadBody,
) => {
  const [state, setState] = useState({});
  useEffect(() => {
    let didCleanup = false;
    const abortController = new AbortController();
    const fetchData = async () => {
      try {
        const response = await fetch(url, {
          signal: abortController.signal
        });
        if (!response.ok) {
          throw new Error('status: ' + response.status);
        }
        const data = await response.json();
        if (!didCleanup) {
          setState({ data });
        }
      } catch (error) {
        if (!didCleanup) {
          setState({ error });
        }
      }
    };
    setState({ loading: true });
    fetchData();
    const cleanup = () => {
      didCleanup = true;
      abortController.abort();
      setState({});
    };
    return cleanup;
  }, [url]);
  return state;
};
```

```js subtitle="Put opts to the second arg of fetch"
const defaultOpts = {};
const defaultReadBody = body => body.json();
const useFetch = (
  url,
  opts = defaultOpts,
  readBody = defaultReadBody,
) => {
  const [state, setState] = useState({});
  useEffect(() => {
    let didCleanup = false;
    const abortController = new AbortController();
    const fetchData = async () => {
      try {
        const response = await fetch(url, {
          ...opts,
          signal: abortController.signal
        });
        if (!response.ok) {
          throw new Error('status: ' + response.status);
        }
        const data = await response.json();
        if (!didCleanup) {
          setState({ data });
        }
      } catch (error) {
        if (!didCleanup) {
          setState({ error });
        }
      }
    };
    setState({ loading: true });
    fetchData();
    const cleanup = () => {
      didCleanup = true;
      abortController.abort();
      setState({});
    };
    return cleanup;
  }, [url]);
  return state;
};
```

```js subtitle="Use readBody to parse response body"
const defaultOpts = {};
const defaultReadBody = body => body.json();
const useFetch = (
  url,
  opts = defaultOpts,
  readBody = defaultReadBody,
) => {
  const [state, setState] = useState({});
  useEffect(() => {
    let didCleanup = false;
    const abortController = new AbortController();
    const fetchData = async () => {
      try {
        const response = await fetch(url, {
          ...opts,
          signal: abortController.signal
        });
        if (!response.ok) {
          throw new Error('status: ' + response.status);
        }
        const data = await readBody(response);
        if (!didCleanup) {
          setState({ data });
        }
      } catch (error) {
        if (!didCleanup) {
          setState({ error });
        }
      }
    };
    setState({ loading: true });
    fetchData();
    const cleanup = () => {
      didCleanup = true;
      abortController.abort();
      setState({});
    };
    return cleanup;
  }, [url]);
  return state;
};
```

</CodeSurferLayout>

---

<CodeSurferLayout>
  <Code
    lang="js"
    code={require("!!raw-loader!./final-code.js").default}
    title="Final code"
  />
  {[...Array(41).keys()].map(i => (
    <Code
      focus={`${i+1}:${i+1}`}
      lang="js"
      code={require("!!raw-loader!./final-code.js").default}
      title="Final code"
    />
  ))}
</CodeSurferLayout>

---

# The end
